<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Replicate Whisper Transcription (Client-side)</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    input, button { margin: 0.5em 0; }
    #output { white-space: pre-wrap; margin-top: 1em; }
  </style>
</head>
<body>
  <h2>Replicate Whisper Transcription (Client-side)</h2>
  <label>
    Replicate API Key:
    <input type="password" id="apiKey" size="50" placeholder="Enter your Replicate API key">
    <button onclick="saveKey()">Save Key</button>
  </label>
  <br>
  <input type="file" id="audioFile" accept="audio/*">
  <button onclick="transcribe()">Transcribe</button>
  <div id="output"></div>

  <script>
    // Load API key from localStorage
    document.getElementById('apiKey').value = localStorage.getItem('replicateApiKey') || '';

    function saveKey() {
      const key = document.getElementById('apiKey').value;
      localStorage.setItem('replicateApiKey', key);
      alert('API key saved locally.');
    }

    async function transcribe() {
      const apiKey = localStorage.getItem('replicateApiKey');
      const fileInput = document.getElementById('audioFile');
      const output = document.getElementById('output');
      output.textContent = '';

      if (!apiKey) {
        alert('Please enter and save your Replicate API key.');
        return;
      }
      if (!fileInput.files.length) {
        alert('Please select an audio file.');
        return;
      }

      // Step 1: Upload file to Replicate's /v1/files endpoint
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('content', file);

      let fileUrl;
      try {
        const uploadRes = await fetch('https://api.replicate.com/v1/files', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiKey}` },
          body: formData
        });
        const uploadJson = await uploadRes.json();
        if (!uploadRes.ok) throw new Error(uploadJson.error || 'File upload failed');
        fileUrl = uploadJson.url;
      } catch (err) {
        output.textContent = 'File upload error: ' + err.message;
        return;
      }

      // Step 2: Start Whisper transcription prediction
      const whisperVersion = 'openai/whisper'; // or use a custom version if needed
      try {
        const predictionRes = await fetch('https://api.replicate.com/v1/predictions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            version: whisperVersion,
            input: { audio: fileUrl }
          })
        });
        const predictionJson = await predictionRes.json();
        if (!predictionRes.ok) throw new Error(predictionJson.error || 'Prediction creation failed');
        const predictionId = predictionJson.id;

        // Step 3: Poll for result
        let result;
        for (let i = 0; i < 30; i++) { // up to ~30 seconds
          await new Promise(r => setTimeout(r, 1000));
          const pollRes = await fetch(`https://api.replicate.com/v1/predictions/${predictionId}`, {
            headers: { 'Authorization': `Bearer ${apiKey}` }
          });
          const pollJson = await pollRes.json();
          if (pollJson.status === 'succeeded') {
            result = pollJson.output;
            break;
          }
          if (pollJson.status === 'failed' || pollJson.status === 'canceled') {
            throw new Error('Transcription failed: ' + (pollJson.error || 'Unknown error'));
          }
        }
        output.textContent = result ? (typeof result === 'string' ? result : JSON.stringify(result, null, 2)) : 'No output';
      } catch (err) {
        output.textContent = 'Transcription error: ' + err.message;
      }
    }
  </script>
</body>
</html>
